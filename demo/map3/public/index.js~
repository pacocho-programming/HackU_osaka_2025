import { getRoute } from './osrm.js';

// Firebase 設定
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// Firebase 初期化
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// 地図を初期化
const map = L.map('map').setView([35.681236, 139.767125], 13); // 東京駅

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// 現在地の取得と Firebase への保存
navigator.geolocation.watchPosition(position => {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;

    const userId = "user1"; // 仮のユーザー ID（後で動的に変更可能）

    db.collection("locations").doc(userId).set({
        latitude: lat,
        longitude: lon,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

}, err => console.error(err), { enableHighAccuracy: true });

// マーカーを更新
const markers = {};
db.collection("locations").onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
        const data = change.doc.data();
        const id = change.doc.id;

        if (!markers[id]) {
            markers[id] = L.marker([data.latitude, data.longitude]).addTo(map);
        } else {
            markers[id].setLatLng([data.latitude, data.longitude]);
        }
    });
});

// クリックしてルート表示
let points = [];
map.on('click', function(e) {
    points.push([e.latlng.lat, e.latlng.lng]);

    if (points.length === 2) {
        getRoute(points[0], points[1]);
        points = [];
    }
});
